<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GrÃ¡fico de Consumo </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: #f4f8fb;
            font-family: 'Segoe UI', sans-serif;
        }

        h5.card-title {
            font-weight: bold;
        }

        #graficoContainer {
            height: 400px;
        }

        .btn-servicio {
            border-radius: 2rem;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: 0.3s;
            border: 2px solid transparent;
        }

        .btn-servicio.active {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
            transform: scale(1.03);
        }

        .btn-agua {
            background-color: #0d6efd;
            color: white;
        }

        .btn-energia {
            background-color: #ffc107;
            color: black;
        }

        .btn-gas {
            background-color: #dc3545;
            color: white;
        }

        .btn-agua:hover {
            background-color: #0b5ed7;
        }

        .btn-energia:hover {
            background-color: #e0a800;
        }

        .btn-gas:hover {
            background-color: #c82333;
        }

        #filtroOrden {
            border-radius: 2rem;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
        }

        .card.shadow {
            border-radius: 1.25rem;
        }

        #cardPromedio {
            border-radius: 1.25rem;
        }
    </style>
</head>
<body>


<div class="container mt-5">

    <!-- Tarjeta con el promedio de consumo del hogar -->
    <div class="mb-4">
        <div id="cardPromedio" class="card text-white shadow">
            <div class="card-body text-center">
                <h5 class="card-title">Promedio mensual de consumo del hogar</h5>
                <p class="card-text display-6" id="promedioValor">--</p>
            </div>
        </div>
    </div>

    <!-- Botones para seleccionar tipo de servicio -->
    <div class="mb-3 d-flex justify-content-between flex-wrap gap-2">
        <div class="d-flex gap-2">
            <button class="btn btn-servicio btn-agua active" onclick="cargarGrafico('agua', ordenSeleccionado)">ðŸ’§ Agua</button>
            <button class="btn btn-servicio btn-energia" onclick="cargarGrafico('energÃ­a', ordenSeleccionado)">âš¡ EnergÃ­a</button>
            <button class="btn btn-servicio btn-gas" onclick="cargarGrafico('gas', ordenSeleccionado)">ðŸ”¥ Gas</button>
        </div>
        <button id="filtroOrden" class="btn btn-outline-dark" onclick="cambiarOrden()">
            <i class="fas fa-sort-amount-up"></i> Orden
        </button>
    </div>

    <!-- Contenedor del grÃ¡fico -->
    <div class="card shadow">
        <div class="card-body">
            <div id="graficoContainer">
                <canvas id="graficoConsumoPorHabitante"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
    let ordenSeleccionado = 'asc';

    function cambiarOrden() {
        ordenSeleccionado = ordenSeleccionado === 'asc' ? 'desc' : 'asc';
        const tipo = document.querySelector('.btn-servicio.active')?.innerText.toLowerCase().replace('ðŸ’§ ', '').replace('âš¡ ', '').replace('ðŸ”¥ ', '') || 'agua';
        cargarGrafico(tipo, ordenSeleccionado);

        const iconoOrden = document.querySelector('#filtroOrden i');
        iconoOrden.classList.toggle('fa-sort-amount-up');
        iconoOrden.classList.toggle('fa-sort-amount-down');
    }

    function cargarGrafico(tipoServicio, orden) {
        document.querySelectorAll('.btn-servicio').forEach(btn => btn.classList.remove('active'));
        const selectedBtn = Array.from(document.querySelectorAll('.btn-servicio')).find(btn =>
            btn.innerText.toLowerCase().includes(tipoServicio)
        );
        if (selectedBtn) selectedBtn.classList.add('active');

        fetch(`/api/consumos/${tipoServicio}/${orden}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('graficoConsumoPorHabitante').getContext('2d');

                if (window.graficoConsumo) {
                    window.graficoConsumo.destroy();
                }

                const colores = data.consumosTotales.map(consumo =>
                    consumo <= data.promedioPorHogar
                        ? 'rgba(34, 172, 26, 0.89)'
                        : 'rgba(255, 99, 132, 0.7)'
                );

                window.graficoConsumo = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: `Consumo mensual del hogar (${tipoServicio})`,
                                data: data.consumosTotales,
                                backgroundColor: colores,
                                borderColor: colores.map(c => c.replace('0.7', '1')),
                                borderWidth: 1
                            },
                            {
                                type: 'line',
                                label: 'Promedio estimado por hogar',
                                data: Array(data.consumosTotales.length).fill(data.promedioPorHogar),
                                borderColor: 'rgba(54, 162, 235, 0.8)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Consumo total del hogar'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const index = context.dataIndex;
                                        const porHabitante = data.consumosPorHabitante[index];
                                        return [
                                            `${context.dataset.label}: ${context.raw.toFixed(2)}`,
                                            `Consumo por habitante: ${porHabitante.toFixed(2)}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });

                document.getElementById('promedioValor').textContent = data.promedioConsumoHogar.toFixed(2);
                const card = document.getElementById('cardPromedio');
                card.classList.remove('bg-success', 'bg-danger');
                card.classList.add(
                    data.promedioConsumoHogar <= data.promedioPorHogar ? 'bg-success' : 'bg-danger'
                );
            });
    }

    window.onload = () => cargarGrafico('agua', 'asc');
</script>

</body>
</html>
